# Medusa 购物车流程

1. **主购物车作为唯一数据源**  
   使用一个持久化的 Medusa 购物车存放所有商品（用户的“购物袋”）。未登录 customer 购物车 ID 保存在 localStorage 中，始终从后端获取完整购物车数据。已登录 customer 优先从账户获取关联的 Cart ID。

2. **购物车页面交互**  
   - 页面加载/刷新时从后端获取最新购物车数据并显示。
   - 所有商品显示复选框（默认选中）和数量调整控件。  
   - 复选框的勾选/取消仅在前端本地状态维护（不同步后端）。  
   - 数量调整：前端乐观更新 + 立即调用 updateLineItem 同步到后端（标准 Medusa 操作）。

3. **处理不可用商品**  
   - 每次获取购物车时，前/后端检查商品库存和状态。  
   - 若商品售罄或下架：通过自定义 API/Workflow 自动从主购物车移除，并显示在独立的“不可用商品”区域。  
   - 若用户尝试增加已售罄商品的数量：后端拒绝 updateLineItem，前端显示错误提示。

4. **进入结账流程**  
   - 用户点击“去结账”（部分商品已勾选）。  
   - 前端调用自定义 API, 发送已勾选的商品 line item ID 和数量。  
   - 后端执行自定义工作流：  
     -	创建一个新的临时结账购物车。  
     -	将仅勾选的商品及数量复制到新购物车。  
     -	从主购物车中删除已勾选的商品。  
     -	使用新购物车进入标准结账流程。

5. **订单完成后**  
   - 新购物车完成结账 → 转为订单。  
   - 主购物车仅保留未勾选的商品，供后续使用。  
   - 不可用商品保持在单独区域。